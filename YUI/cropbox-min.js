"use strict";YUI.add("crop-box",function(t){t.cropbox=t.Base.create("crop-box",t.Base,[],{initializer:function(t){this.options=t,this.state={},this.render()},render:function(){return this.imageBox=t.one(this.options.imageBox),this.thumbBox=this.imageBox.one(this.options.thumbBox),this.spinner=this.imageBox.one(this.options.spinner),this.initObject(),this},initObject:function(){var e=this;this.spinner.show(),this.image=new Image,this.image.onload=function(){e.spinner.hide(),e.setBackground(),e.mouseup=t.one("body").on("mouseup",e.imgMouseUp,e),e.imageBox.on("mousedown",e.imgMouseDown,e),e.imageBox.on("mousemove",e.imgMouseMove,e),e.touchend=t.one("body").on("touchend",e.imgTouchUp,e),e.imageBox.on("touchstart",e.imgTouchDown,e),e.imageBox.on("touchmove",e.imgTouchMove,e),t.UA.gecko>0?e.imageBox.on("DOMMouseScroll",e.zoomImage,e):e.imageBox.on("mousewheel",e.zoomImage,e)},this.image.src=this.options.imgSrc},setBackground:function(){this.ratio||(this.ratio=1);var t=parseInt(this.image.width)*this.ratio,e=parseInt(this.image.height)*this.ratio,i=(this.imageBox.get("clientWidth")-t)/2,o=(this.imageBox.get("clientHeight")-e)/2;this.imageBox.setAttribute("style","background-image: url("+this.image.src+"); background-size: "+t+"px "+e+"px; background-position: "+i+"px "+o+"px; background-repeat: no-repeat")},imgMouseDown:function(t){t.stopImmediatePropagation(),this.state.dragable=!0,this.state.mouseX=t.clientX,this.state.mouseY=t.clientY},imgTouchDown:function(t){t.stopImmediatePropagation(),obj.state.dragable=!0,obj.state.mouseX=t.changedTouches[0].clientX,obj.state.mouseY=t.changedTouches[0].clientY},imgMouseMove:function(t){if(t.stopImmediatePropagation(),this.state.dragable){var e=t.clientX-this.state.mouseX,i=t.clientY-this.state.mouseY,o=this.imageBox.getStyle("backgroundPosition").split(" "),s=e+parseInt(o[0]),a=i+parseInt(o[1]);this.imageBox.setStyle("backgroundPosition",s+"px "+a+"px"),this.state.mouseX=t.clientX,this.state.mouseY=t.clientY}},imgTouchMove:function(t){if(t.stopImmediatePropagation(),obj.state.dragable){var e=t.changedTouches[0].clientX-obj.state.mouseX,i=t.changedTouches[0].clientY-obj.state.mouseY,o=this.imageBox.getStyle("backgroundPosition").split(" "),s=e+parseInt(o[0]),a=i+parseInt(o[1]);this.imageBox.setStyle("backgroundPosition",s+"px "+a+"px"),obj.state.mouseX=t.changedTouches[0].clientX,obj.state.mouseY=t.changedTouches[0].clientY}},imgMouseUp:function(t){t.stopImmediatePropagation(),this.state.dragable=!1},imgTouchUp:function(t){t.stopImmediatePropagation(),obj.state.dragable=!1},zoomImage:function(t){t.wheelDelta>0?this.ratio*=1.1:this.ratio*=.9,this.setBackground()},getDataURL:function(){var t=this.thumbBox.get("clientWidth"),e=this.thumbBox.get("clientHeight"),i=document.createElement("canvas"),o=this.imageBox.getStyle("backgroundPosition").split(" "),s=this.imageBox.getStyle("backgroundSize").split(" "),a=parseInt(o[0])-this.imageBox.get("clientWidth")/2+t/2,n=parseInt(o[1])-this.imageBox.get("clientHeight")/2+e/2,g=parseInt(s[0]),h=parseInt(s[1]),m=parseInt(this.image.height),u=parseInt(this.image.width);return i.width=t,i.height=e,i.getContext("2d").drawImage(this.image,0,0,u,m,a,n,g,h),i.toDataURL("image/png")},getBlob:function(){for(var t=this.getDataURL().replace("data:image/png;base64,",""),e=atob(t),i=[],o=0;o<e.length;o++)i.push(e.charCodeAt(o));return new Blob([new Uint8Array(i)],{type:"image/png"})},zoomIn:function(){this.ratio*=1.1,this.setBackground()},zoomOut:function(){this.ratio*=.9,this.setBackground()},destructor:function(){this.mouseup&&this.mouseup.detach()}})},"1.0",{requires:["node","base"]});
